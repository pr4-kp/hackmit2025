<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Prooffolio — Resume or Papers</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0f0f11; --panel:#16171a; --muted:#9aa0a6; --text:#e8eaed; --brand:#8ab4f8; }
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 16px}
    .panel{background:var(--panel);border:1px solid #27282b;border-radius:12px;padding:16px;margin:12px 0}
    label{display:block;margin:10px 0 6px;color:var(--muted)}
    input[type=file],textarea{width:100%;background:#0e0f11;color:var(--text);border:1px solid #2a2b2e;border-radius:8px;padding:10px}
    textarea{min-height:70px}
    .btn{background:var(--brand);color:#0b1020;border:0;padding:10px 14px;border-radius:8px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    pre{white-space:pre-wrap;background:#0b0c0e;border:1px solid #222;border-radius:10px;padding:12px;overflow:auto}
    .grid{display:grid;gap:12px}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .card{border:1px solid #26272a;border-radius:12px;padding:12px;background:#111214}
    .muted{color:var(--muted)}
    .badge{display:inline-block;border:1px solid #2b2c2f;border-radius:999px;padding:2px 8px;margin:2px 4px 0 0;font-size:12px;color:#cbd5e1}
    .small{font-size:12px}
    a.link{color:var(--brand);text-decoration:none}

    .job-head{display:flex;align-items:baseline;justify-content:space-between;gap:8px}
    .score{font-weight:800}
    .keywords{margin-top:8px}
    @media (max-width:860px){ .grid-3{grid-template-columns:repeat(2,minmax(0,1fr))} }
    @media (max-width:560px){ .grid-3{grid-template-columns:1fr} }

    .filechips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .chip{border:1px solid #2b2c2f;border-radius:999px;padding:3px 8px;font-size:12px;color:#cbd5e1;background:#111214}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Prooffolio — Upload a resume <span class="muted">or</span> papers</h1>

    <div class="panel">
      <form id="uform">
        <label>Resume (PDF — optional)</label>
        <input type="file" id="resume" name="resume" accept="application/pdf" />
        <div id="resumeChip" class="filechips" aria-live="polite"></div>

        <label style="margin-top:12px">Papers (PDFs — optional)</label>
        <input type="file" id="papers" name="papers" accept="application/pdf" multiple />
        <div id="papersChips" class="filechips" aria-live="polite"></div>

        <label style="margin-top:12px">About / Interests (optional)</label>
        <textarea id="about" name="about" placeholder="Short about... e.g., Python + dashboards; interested in sustainability and AI policy."></textarea>

        <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
          <button class="btn" id="submitBtn">Process</button>
          <span id="status" class="muted small"></span>
        </div>
      </form>
    </div>

    <div id="results" class="grid" style="margin-top:16px;display:none">
      <div class="panel">
        <h2 style="margin:0 0 8px">Artifacts</h2>
        <div id="artifacts" class="grid grid-3"></div>
      </div>
      <div class="panel">
        <h2 style="margin:0 0 8px">Skills (with proof)</h2>
        <div id="skills" class="grid grid-3"></div>
      </div>
      <div class="panel">
        <h2 style="margin:0 0 8px">Projects</h2>
        <div id="projects" class="grid grid-3"></div>
      </div>

      <div class="panel" id="jobsPanel" style="display:none">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <h2 style="margin:0">Recommended Jobs</h2>
          <span id="jobsMeta" class="small muted"></span>
        </div>
        <div id="jobs" class="grid grid-3" style="margin-top:8px"></div>
        <div id="jobsEmpty" class="small muted" style="margin-top:8px;display:none">No matches yet.</div>
      </div>

      <div class="panel">
        <details>
          <summary>Raw JSON</summary>
          <pre id="raw"></pre>
        </details>
      </div>
    </div>
  </div>

  <script>
    const API = 'http://localhost:3000';

    const form = document.getElementById('uform');
    const btn  = document.getElementById('submitBtn');
    const statusEl = document.getElementById('status');
    const results = document.getElementById('results');

    const resumeInput = document.getElementById('resume');
    const papersInput = document.getElementById('papers');
    const resumeChip  = document.getElementById('resumeChip');
    const papersChips = document.getElementById('papersChips');

    const jobsPanel = document.getElementById('jobsPanel');
    const jobsMeta  = document.getElementById('jobsMeta');
    const jobsBox   = document.getElementById('jobs');
    const jobsEmpty = document.getElementById('jobsEmpty');

    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }
    function chip(text){
      const span = document.createElement('span');
      span.className = 'chip';
      span.textContent = text;
      return span;
    }

    resumeInput.addEventListener('change', (e) => {
      resumeChip.innerHTML = '';
      const f = e.target.files && e.target.files[0];
      if (f) resumeChip.appendChild(chip(`Resume: ${f.name}`));
      statusEl.textContent = f ? `Selected: ${f.name}` : '';
    });

    papersInput.addEventListener('change', (e) => {
      papersChips.innerHTML = '';
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      files.slice(0,5).forEach(f => papersChips.appendChild(chip(f.name)));
      if (files.length > 5) papersChips.appendChild(chip(`+${files.length-5} more`));
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      btn.disabled = true;
      results.style.display = 'none';
      jobsPanel.style.display = 'none';

      try {
        const fd = new FormData();

        const resume = resumeInput.files[0] || null;
        const papers = papersInput.files || [];

        if (!resume && papers.length === 0) {
          throw new Error('Please add a resume or at least one paper PDF.');
        }

        if (resume) fd.append('resume', resume);
        for (const p of papers) fd.append('papers', p);
        fd.append('about', document.getElementById('about').value || '');

        const nSources = (resume ? 1 : 0) + papers.length;
        statusEl.textContent = `Uploading ${nSources} source${nSources===1?'':'s'}…`;

        const r = await fetch(API + '/process', { method:'POST', body: fd });
        const text = await r.text();
        let data;
        try { data = JSON.parse(text); } catch { throw new Error(text || 'Invalid JSON'); }

        renderArtifacts(data.artifacts || []);
        renderSkills(data.skills || []);
        renderProjects(data.projects || []);
        document.getElementById('raw').textContent = JSON.stringify(data, null, 2);
        results.style.display = '';

        const savedLink = API + '/outputs/latest.json';
        const firstTitle = (data.artifacts && data.artifacts[0] && (data.artifacts[0].title || data.artifacts[0].id)) || (resume ? 'resume.pdf' : 'papers');
        const rCount = (data.counts && data.counts.resume) ? data.counts.resume : (resume ? 1 : 0);
        const pCount = (data.counts && typeof data.counts.papers === 'number') ? data.counts.papers : papers.length || 0;
        const noteParts = [];
        if (rCount) noteParts.push(`${rCount} resume`);
        if (pCount) noteParts.push(`${pCount} paper${pCount===1?'':'s'}`);
        const note = noteParts.length ? ` (${noteParts.join(' + ')})` : '';
        statusEl.innerHTML = `Processed: <b>${escapeHtml(firstTitle)}</b>${note} — saved to <a class="link" href="${savedLink}" target="_blank">outputs/latest.json</a>`;

        // Fetch job recommendations
        await loadJobRecommendations(9);

      } catch (err) {
        statusEl.textContent = 'Error: ' + (err.message || err);
        console.error(err);
      } finally {
        btn.disabled = false;
      }
    });

    async function loadJobRecommendations(limit = 9){
      try {
        jobsMeta.textContent = 'Finding matches…';
        jobsBox.innerHTML = '';
        jobsEmpty.style.display = 'none';
        jobsPanel.style.display = '';

        const r = await fetch(`${API}/jobs/recommend?limit=${limit}`);
        const rec = await r.json();

        const matches = rec && rec.matches ? rec.matches : [];
        jobsMeta.textContent = `${matches.length} shown • jobs loaded: ${rec.total_jobs ?? '—'}`;

        if (!matches.length){
          jobsEmpty.style.display = '';
          return;
        }
        renderJobs(matches);
      } catch (e) {
        jobsMeta.textContent = 'Error loading matches';
        console.error(e);
      }
    }

    function renderJobs(items){
      jobsBox.innerHTML = '';
      for (const j of items){
        const div = document.createElement('div');
        div.className = 'card';
        const kws = Array.isArray(j.keywords) ? j.keywords.slice(0,8) : [];
        div.innerHTML = `
          <div class="job-head">
            <div>
              <div><b>${escapeHtml(j.title || 'Role')}</b></div>
              <div class="small muted" style="margin-top:4px">${escapeHtml(j.company || 'Company')} • ${escapeHtml(j.location || 'Location')}</div>
            </div>
            <div class="score">${(Number(j.match_score)||0)}%</div>
          </div>
          ${j.reason ? `<div class="small" style="margin-top:8px">Reason: ${escapeHtml(j.reason)}</div>` : ''}
          ${kws.length ? `<div class="keywords">${kws.map(k=>`<span class="badge">${escapeHtml(String(k))}</span>`).join('')}</div>` : ''}
        `;
        jobsBox.appendChild(div);
      }
    }

    function renderArtifacts(items){
      const box = document.getElementById('artifacts'); box.innerHTML = '';
      for (const a of items){
        const div = document.createElement('div');
        div.className = 'card';
        const id = a.id ? ` (${escapeHtml(a.id)})` : '';
        div.innerHTML = `
          <div><b>${escapeHtml(a.title || a.id)}</b><span class="small muted">${id}</span></div>
          <div class="small muted">${escapeHtml(a.type || '')}</div>
          <div class="small" style="margin-top:6px">${escapeHtml((a.text_excerpt || '').slice(0,180))}…</div>
        `;
        box.appendChild(div);
      }
    }

    function renderSkills(items){
      const box = document.getElementById('skills'); box.innerHTML = '';
      for (const s of items){
        const div = document.createElement('div');
        const ev = (s.evidence && s.evidence[0]) || null;
        div.className = 'card';
        div.innerHTML = `
          <div><b>${escapeHtml(s.name)}</b> <span class="badge">${escapeHtml(s.level || '')}</span></div>
          ${ev ? `<div class="small muted" style="margin-top:6px">Proof (${escapeHtml(ev.artifact_id)}): “${escapeHtml((ev.snippet||'').slice(0,160))}”</div>` : ''}
        `;
        box.appendChild(div);
      }
    }

    function renderProjects(items){
      const box = document.getElementById('projects'); box.innerHTML = '';
      for (const p of items){
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div><b>${escapeHtml(p.title || 'Project')}</b></div>
          <div class="small" style="margin-top:6px">${escapeHtml(p.summary || '')}</div>
        `;
        box.appendChild(div);
      }
    }
  </script>
</body>
</html>
